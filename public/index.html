<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Certificats We Are Moving Mountains</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #e8e0d4;
      --card:      #faf7f2;
      --border:    rgba(166, 124, 46, 0.28);
      --gold:      #a67c2e;
      --gold-dim:  rgba(166, 124, 46, 0.5);
      --gold-bg:   rgba(166, 124, 46, 0.07);
      --text:      #231e17;
      --muted:     rgba(35, 30, 23, 0.5);
      --error:     #b84040;
      --success:   #3d7a55;
    }

    /* ── Fond ─────────────────────────────────────────────────────── */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg);
      font-family: 'DM Sans', sans-serif;
      padding: 2rem;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image:
        radial-gradient(ellipse 80% 60% at 15% 105%, rgba(166,124,46,0.13) 0%, transparent 58%),
        radial-gradient(ellipse 55% 45% at 85% -5%,  rgba(166,124,46,0.09) 0%, transparent 52%);
      pointer-events: none;
    }

    /* ── Carte principale ─────────────────────────────────────────── */
    .card {
      position: relative;
      width: 100%;
      max-width: 480px;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 3rem 3rem 2.75rem;
      box-shadow:
        0 2px 0   rgba(166,124,46,0.12),
        0 4px 32px rgba(35,30,23,0.08),
        0 1px 4px  rgba(35,30,23,0.05);
      animation: rise 0.7s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Coins dorés */
    .card::before, .card::after,
    .corner-bl, .corner-br {
      content: '';
      position: absolute;
      width: 14px; height: 14px;
      border-color: var(--gold);
      border-style: solid;
    }
    .card::before  { top: 10px;    left: 10px;  border-width: 1px 0 0 1px; }
    .card::after   { top: 10px;    right: 10px; border-width: 1px 1px 0 0; }
    .corner-bl     { bottom: 10px; left: 10px;  border-width: 0 0 1px 1px; }
    .corner-br     { bottom: 10px; right: 10px; border-width: 0 1px 1px 0; }

    /* ── En-tête ──────────────────────────────────────────────────── */
    .header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .title {
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--text);
      line-height: 1.45;
    }

    .title strong {
      display: block;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gold);
      letter-spacing: 0.02em;
      margin-top: 0.2rem;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 1.5rem 0;
    }
    .divider-line { flex: 1; height: 1px; background: var(--border); }
    .divider-dot  { width: 4px; height: 4px; background: var(--gold-dim); transform: rotate(45deg); flex-shrink: 0; }

    /* ── Champ date ───────────────────────────────────────────────── */
    .field { position: relative; margin-bottom: 2rem; }

    .field label {
      display: block;
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.6rem;
    }

    .field input {
      width: 100%;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 0 0.6rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
      font-weight: 300;
      color: var(--text);
      outline: none;
      transition: border-color 0.25s;
      caret-color: var(--gold);
    }
    .field input::placeholder { color: rgba(35,30,23,0.22); }
    .field input:focus         { border-bottom-color: var(--gold); }

    .field-bar {
      position: absolute;
      bottom: 0; left: 0;
      height: 1px; width: 0;
      background: var(--gold);
      transition: width 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .field input:focus ~ .field-bar { width: 100%; }

    /* ── Section noms ─────────────────────────────────────────────── */
    .names-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .names-label {
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .names-count {
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--gold-dim);
      letter-spacing: 0.05em;
    }

    /* ── Rangées de noms ──────────────────────────────────────────── */
    #namesList {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .name-row {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      animation: fadeIn 0.25s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .name-field {
      flex: 1;
      position: relative;
      margin-bottom: 0;
    }

    .name-field input {
      width: 100%;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 0 0.6rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 300;
      color: var(--text);
      outline: none;
      transition: border-color 0.25s;
      caret-color: var(--gold);
    }
    .name-field input::placeholder { color: rgba(35,30,23,0.22); }
    .name-field input:focus         { border-bottom-color: var(--gold); }

    .name-bar {
      position: absolute;
      bottom: 0; left: 0;
      height: 1px; width: 0;
      background: var(--gold);
      transition: width 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .name-field input:focus ~ .name-bar { width: 100%; }

    .remove-btn {
      flex-shrink: 0;
      width: 28px; height: 28px;
      background: none;
      border: 1px solid var(--border);
      color: var(--gold-dim);
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1px;
      transition: color 0.2s, border-color 0.2s, background 0.2s;
    }
    .remove-btn:hover {
      color: var(--error);
      border-color: rgba(184,64,64,0.4);
      background: rgba(184,64,64,0.05);
    }
    .remove-btn:disabled { opacity: 0.2; cursor: not-allowed; }

    /* ── Bouton ajouter un nom ────────────────────────────────────── */
    .add-btn {
      margin-top: 1rem;
      padding: 0.45rem 0.75rem;
      background: none;
      border: 1px dashed var(--border);
      color: var(--gold-dim);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.12em;
      cursor: pointer;
      width: 100%;
      text-align: center;
      transition: color 0.2s, border-color 0.2s, background 0.2s;
    }
    .add-btn:hover {
      color: var(--gold);
      border-color: var(--gold-dim);
      background: var(--gold-bg);
    }

    /* ── Bouton principal ─────────────────────────────────────────── */
    .btn-wrap { margin-top: 2rem; }

    .btn {
      width: 100%;
      position: relative;
      padding: 0.85rem 1.5rem;
      background: transparent;
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      overflow: hidden;
      transition: color 0.3s, border-color 0.3s;
    }
    .btn::before {
      content: '';
      position: absolute; inset: 0;
      background: var(--gold);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
      z-index: 0;
    }
    .btn:hover:not(:disabled)::before { transform: scaleX(1); }
    .btn:hover:not(:disabled) { color: var(--card); border-color: var(--gold); }
    .btn:active:not(:disabled) { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn span { position: relative; z-index: 1; }

    /* ── Liste de résultats ───────────────────────────────────────── */
    #resultsList {
      margin-top: 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 0;
      border-bottom: 1px solid var(--border);
      animation: fadeIn 0.3s ease both;
    }
    .result-item:first-child { border-top: 1px solid var(--border); }

    .result-name {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 400;
      color: var(--text);
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-status {
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .result-status.waiting  { color: var(--gold-dim); }
    .result-status.running  { color: var(--gold); }
    .result-status.done     { color: var(--success); }
    .result-status.failed   { color: var(--error); }

    .result-download {
      flex-shrink: 0;
      padding: 0.3rem 0.65rem;
      background: rgba(61,122,85,0.1);
      border: 1px solid rgba(61,122,85,0.35);
      color: var(--success);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.62rem;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      text-decoration: none;
      transition: background 0.2s;
    }
    .result-download:hover {
      background: rgba(61,122,85,0.2);
    }

    /* Spinner inline */
    .spinner {
      display: inline-block;
      width: 9px; height: 9px;
      border: 1.5px solid var(--gold-dim);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
      margin-right: 0.3rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Barre de progression globale ────────────────────────────── */
    .progress-bar-wrap {
      margin-top: 1.25rem;
      height: 2px;
      background: var(--border);
      overflow: hidden;
      display: none;
    }
    .progress-bar-wrap.visible { display: block; }
    .progress-bar {
      height: 100%;
      background: var(--gold);
      transition: width 0.4s ease;
      width: 0%;
    }

    /* ── Pied de page ─────────────────────────────────────────────── */
    .footer {
      text-align: center;
      margin-top: 2.25rem;
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(35,30,23,0.22);
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="corner-bl"></div>
    <div class="corner-br"></div>

    <!-- En-tête -->
    <div class="header">
      <h1 class="title">
        Certificats
        <strong>We Are Moving Mountains</strong>
      </h1>
      <div class="divider">
        <div class="divider-line"></div>
        <div class="divider-dot"></div>
        <div class="divider-line"></div>
      </div>
    </div>

    <form id="certForm" novalidate>

      <!-- Date partagée -->
      <div class="field">
        <label for="date">Date du certificat</label>
        <input
          type="text"
          id="date"
          name="date"
          placeholder="17 janvier 2026"
          required>
        <div class="field-bar"></div>
      </div>

      <!-- Noms -->
      <div class="names-header">
        <span class="names-label">Noms des bénéficiaires</span>
        <span class="names-count" id="namesCount">1 certificat</span>
      </div>

      <div id="namesList">
        <!-- Rangées ajoutées dynamiquement -->
      </div>

      <button type="button" class="add-btn" id="addNameBtn">+ Ajouter un nom</button>

      <div class="btn-wrap">
        <button type="submit" class="btn" id="submitBtn">
          <span id="submitLabel">Générer le certificat</span>
        </button>
      </div>

    </form>

    <!-- Barre de progression globale -->
    <div class="progress-bar-wrap" id="progressWrap">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Liste de résultats -->
    <div id="resultsList"></div>

    <p class="footer">InDesign Server · AWS S3</p>
  </div>

  <script>
    // ── État ─────────────────────────────────────────────────────────
    let rowCount    = 0;
    let activeJobs  = [];   // { nom, jobId, status, el }
    let pollTimer   = null;

    // ── Références DOM ───────────────────────────────────────────────
    const form        = document.getElementById('certForm');
    const submitBtn   = document.getElementById('submitBtn');
    const submitLabel = document.getElementById('submitLabel');
    const namesList   = document.getElementById('namesList');
    const namesCount  = document.getElementById('namesCount');
    const addNameBtn  = document.getElementById('addNameBtn');
    const resultsList = document.getElementById('resultsList');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar  = document.getElementById('progressBar');

    // ── Gestion des rangées de noms ──────────────────────────────────
    function addNameRow(placeholder) {
      rowCount++;
      const row = document.createElement('div');
      row.className = 'name-row';
      row.dataset.id = rowCount;
      row.innerHTML = `
        <div class="name-field">
          <input type="text"
            placeholder="${placeholder || 'Marie-Claire Dupont'}"
            autocomplete="off">
          <div class="name-bar"></div>
        </div>
        <button type="button" class="remove-btn" title="Supprimer" aria-label="Supprimer ce nom">×</button>
      `;
      row.querySelector('.remove-btn').addEventListener('click', () => removeRow(row));
      namesList.appendChild(row);
      updateCount();
      row.querySelector('input').focus();
      return row;
    }

    function removeRow(row) {
      const rows = namesList.querySelectorAll('.name-row');
      if (rows.length <= 1) return; // toujours au moins 1
      row.remove();
      updateCount();
    }

    function updateCount() {
      const n = namesList.querySelectorAll('.name-row').length;
      namesCount.textContent = n === 1 ? '1 certificat' : `${n} certificats`;
      submitLabel.textContent = n === 1 ? 'Générer le certificat' : `Générer ${n} certificats`;
      // Le × du seul champ restant est désactivé
      namesList.querySelectorAll('.remove-btn').forEach(btn => {
        btn.disabled = (n === 1);
      });
    }

    function getNames() {
      return Array.from(namesList.querySelectorAll('.name-row input'))
        .map(i => i.value.trim())
        .filter(v => v.length > 0);
    }

    // ── Construction d'un item de résultat ──────────────────────────
    function createResultItem(nom) {
      const el = document.createElement('div');
      el.className = 'result-item';
      el.innerHTML = `
        <span class="result-name">${escHtml(nom)}</span>
        <span class="result-status waiting">En attente</span>
      `;
      resultsList.appendChild(el);
      return el;
    }

    function setItemStatus(el, status, downloadUrl) {
      const st = el.querySelector('.result-status');
      // Supprimer l'ancien lien éventuel
      const existing = el.querySelector('.result-download');
      if (existing) existing.remove();

      if (status === 'running') {
        st.className = 'result-status running';
        st.innerHTML = '<span class="spinner"></span>En cours';
      } else if (status === 'done') {
        st.className = 'result-status done';
        st.textContent = '✓ Prêt';
        if (downloadUrl) {
          const a = document.createElement('a');
          a.className = 'result-download';
          a.href = downloadUrl;
          a.download = '';
          a.textContent = '↓ PDF';
          el.appendChild(a);
        }
      } else if (status === 'failed') {
        st.className = 'result-status failed';
        st.textContent = 'Échec';
      }
    }

    function updateProgress() {
      const total = activeJobs.length;
      const done  = activeJobs.filter(j => j.status === 'done' || j.status === 'failed').length;
      progressBar.style.width = total ? `${(done / total) * 100}%` : '0%';
      if (done === total && total > 0) {
        setTimeout(() => { progressWrap.classList.remove('visible'); }, 1200);
        submitBtn.disabled = false;
        addNameBtn.disabled = false;
      }
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Soumission du formulaire ─────────────────────────────────────
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (pollTimer) clearInterval(pollTimer);

      const date  = document.getElementById('date').value.trim();
      const names = getNames();

      if (!date) {
        document.getElementById('date').focus();
        return;
      }
      if (names.length === 0) {
        namesList.querySelector('input')?.focus();
        return;
      }

      // Préparer l'interface
      submitBtn.disabled   = true;
      addNameBtn.disabled  = true;
      resultsList.innerHTML = '';
      activeJobs = [];
      progressWrap.classList.add('visible');
      progressBar.style.width = '0%';

      // Créer tous les items de résultat
      names.forEach(nom => {
        const el = createResultItem(nom);
        activeJobs.push({ nom, jobId: null, status: 'pending', el });
      });

      // Soumettre tous les jobs en parallèle
      await Promise.all(activeJobs.map(async (job) => {
        setItemStatus(job.el, 'running');
        job.status = 'running';
        try {
          const res  = await fetch('/generate', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body:    JSON.stringify({ nom: job.nom, date })
          });
          const data = await res.json();
          if (res.ok && data.jobId) {
            job.jobId = data.jobId;
          } else {
            job.status = 'failed';
            setItemStatus(job.el, 'failed');
          }
        } catch {
          job.status = 'failed';
          setItemStatus(job.el, 'failed');
        }
        updateProgress();
      }));

      // Démarrer le polling global
      startPolling();
    });

    // ── Polling global (tous les jobs actifs) ────────────────────────
    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        const pending = activeJobs.filter(j => j.status === 'running' && j.jobId);
        if (pending.length === 0) {
          clearInterval(pollTimer);
          return;
        }

        await Promise.all(pending.map(async (job) => {
          try {
            const res  = await fetch(`/check-status/${job.jobId}`);
            const data = await res.json();

            if (data.status === 'done') {
              job.status = 'done';
              setItemStatus(job.el, 'done', data.downloadUrl);
              updateProgress();
            } else if (data.status === 'failed') {
              job.status = 'failed';
              setItemStatus(job.el, 'failed');
              updateProgress();
            }
            // 'in-progress' → on continue de poller
          } catch {
            job.status = 'failed';
            setItemStatus(job.el, 'failed');
            updateProgress();
          }
        }));

        // Arrêter si tous terminés
        const allDone = activeJobs.every(j => j.status === 'done' || j.status === 'failed');
        if (allDone) clearInterval(pollTimer);

      }, 3000);
    }

    // ── Bouton ajouter ───────────────────────────────────────────────
    addNameBtn.addEventListener('click', () => addNameRow());

    // ── Initialisation : 1 champ au départ ──────────────────────────
    addNameRow('Marie-Claire Dupont');
  </script>

</body>
</html>
